<div class="movie-detail-page">
  <!-- Hero Section with Backdrop -->
  <div class="movie-hero" style="
    background: linear-gradient(to bottom, rgba(0,0,0,0.7), rgba(26,26,26,0.95)), 
                url('https://image.tmdb.org/t/p/original<%= @movie.backdrop_path %>') center/cover;
    padding: 60px 20px;
    margin: -20px -20px 40px -20px;
  ">
    <div class="movie-hero-content" style="max-width: 1200px; margin: 0 auto; display: flex; gap: 40px; align-items: flex-start;">
      <!-- Poster -->
      <div class="movie-poster-large" style="flex-shrink: 0;">
        <% if @movie.poster_path %>
          <img src="https://image.tmdb.org/t/p/w500<%= @movie.poster_path %>" 
               alt="<%= @movie.title %>" 
               style="width: 300px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.4);">
        <% else %>
          <div style="width: 300px; height: 450px; background: var(--card-bg); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #666;">
            No Poster
          </div>
        <% end %>
      </div>

      <!-- Movie Info -->
      <div class="movie-info-main" style="flex: 1; color: white;">
        <h1 style="font-size: 3rem; margin: 0 0 10px 0;"><%= @movie.title %></h1>
        
        <div class="movie-meta" style="display: flex; gap: 20px; margin-bottom: 20px; font-size: 1.1rem; opacity: 0.9;">
          <span><%= @movie.release_date&.year || 'N/A' %></span>
          <span>‚Ä¢</span>
          <span><%= @movie.runtime ? "#{@movie.runtime} min" : 'N/A' %></span>
          <span>‚Ä¢</span>
          <span><%= @movie.production_country&.name %></span>
        </div>

        <div class="movie-rating" style="margin-bottom: 20px;">
          <span style="font-size: 2rem; font-weight: bold; color: var(--accent-color);">‚≠ê <%= @movie.vote_average.round(1) %></span>
          <span style="margin-left: 10px; opacity: 0.8;"><%= @movie.vote_count %> votes</span>
        </div>

        <div class="movie-genres" style="margin-bottom: 30px; display: flex; flex-wrap: wrap; gap: 10px;">
          <% @movie.genres.each do |genre| %>
            <span style="background: rgba(0, 255, 255, 0.2); border: 1px solid var(--accent-color); padding: 6px 16px; border-radius: 20px; font-size: 0.9rem;">
              <%= genre.name %>
            </span>
          <% end %>
        </div>

        <p style="font-size: 1.2rem; line-height: 1.8; margin-bottom: 30px; max-width: 800px;">
          <%= @movie.overview %>
        </p>

        <!-- Action Buttons -->
        <div class="movie-actions" style="display: flex; gap: 15px; flex-wrap: wrap;">
          <% if @watched %>
            <button onclick="toggleWatched(<%= @movie.id %>, false)" class="btn btn--success btn--large">
              ‚úÖ Watched
            </button>
            <%= link_to '‚úçÔ∏è Write Review', new_movie_review_path(@movie), class: 'btn btn--primary btn--large' %>
          <% else %>
            <button onclick="toggleWatched(<%= @movie.id %>, true)" class="btn btn--watched btn--large">
              üëÅÔ∏è Mark as Watched
            </button>
          <% end %>
          <button onclick="showListPicker(<%= @movie.id %>)" class="btn btn--ghost btn--large">
            ‚ûï Add to List
          </button>
          <%= link_to '‚Üê Back', :back, class: 'btn btn--ghost btn--large' %>
        </div>
      </div>
    </div>
  </div>

  <div class="movie-detail-content" style="max-width: 1200px; margin: 0 auto; padding: 0 20px;">
    <!-- Cast & Crew -->
    <section class="movie-section" style="margin-bottom: 60px;">
      <h2 style="font-size: 2rem; margin-bottom: 30px; color: var(--text-color);">Cast & Crew</h2>
      
      <% if @movie_people['Director']&.any? %>
        <div class="crew-section" style="margin-bottom: 30px;">
          <h3 style="font-size: 1.3rem; margin-bottom: 15px; color: var(--accent-color);">Directors</h3>
          <div style="display: flex; flex-wrap: wrap; gap: 20px;">
            <% @movie_people['Director'].each do |mp| %>
              <div class="person-card" style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; width: 200px;">
                <div style="font-weight: 600; margin-bottom: 5px;"><%= mp.person.name %></div>
                <div style="font-size: 0.9rem; color: var(--text-secondary);">Director</div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <% if @movie_people['Actor']&.any? %>
        <div class="crew-section" style="margin-bottom: 30px;">
          <h3 style="font-size: 1.3rem; margin-bottom: 15px; color: var(--accent-color);">Cast</h3>
          <div style="display: flex; flex-wrap: wrap; gap: 20px;">
            <% @movie_people['Actor'].first(10).each do |mp| %>
              <div class="person-card" style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; width: 200px;">
                <div style="font-weight: 600; margin-bottom: 5px;"><%= mp.person.name %></div>
                <div style="font-size: 0.9rem; color: var(--text-secondary);"><%= mp.character || 'Actor' %></div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </section>

    <!-- User's Review -->
    <% if @user_review %>
      <section class="movie-section" style="margin-bottom: 60px;">
        <h2 style="font-size: 2rem; margin-bottom: 30px; color: var(--text-color);">Your Review</h2>
        <div class="review-card" style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 30px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
              <span style="font-size: 2rem; color: var(--accent-color); font-weight: bold;">‚≠ê <%= @user_review.rating %>/10</span>
              <% if @user_review.title.present? %>
                <h3 style="margin: 10px 0 0 0; font-size: 1.5rem;"><%= @user_review.title %></h3>
              <% end %>
            </div>
            <%= link_to 'Edit Review', edit_review_path(@user_review), class: 'btn btn--ghost' %>
          </div>
          <% if @user_review.contains_spoilers %>
            <div style="background: #ff6b6b; color: white; padding: 8px 16px; border-radius: 4px; display: inline-block; margin-bottom: 15px; font-size: 0.9rem;">
              ‚ö†Ô∏è Contains Spoilers
            </div>
          <% end %>
          <p style="line-height: 1.8; color: var(--text-color);"><%= @user_review.review_text %></p>
          <div style="margin-top: 20px; font-size: 0.9rem; color: var(--text-secondary);">
            Reviewed <%= time_ago_in_words(@user_review.created_at) %> ago
            <% if @user_review.updated_at > @user_review.created_at + 1.minute %>
              ‚Ä¢ Edited <%= time_ago_in_words(@user_review.updated_at) %> ago
            <% end %>
          </div>
        </div>
      </section>
    <% end %>

    <!-- Movie Details -->
    <section class="movie-section">
      <h2 style="font-size: 2rem; margin-bottom: 30px; color: var(--text-color);">Details</h2>
      <div class="details-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
        <div class="detail-item" style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px;">
          <div style="font-weight: 600; color: var(--accent-color); margin-bottom: 10px;">Original Language</div>
          <div><%= @movie.original_language.name %></div>
        </div>
        <div class="detail-item" style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px;">
          <div style="font-weight: 600; color: var(--accent-color); margin-bottom: 10px;">Production Country</div>
          <div><%= @movie.production_country.name %></div>
        </div>
        <div class="detail-item" style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px;">
          <div style="font-weight: 600; color: var(--accent-color); margin-bottom: 10px;">Release Date</div>
          <div><%= @movie.release_date&.strftime('%B %d, %Y') || 'N/A' %></div>
        </div>
        <div class="detail-item" style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px;">
          <div style="font-weight: 600; color: var(--accent-color); margin-bottom: 10px;">Runtime</div>
          <div><%= @movie.runtime ? "#{@movie.runtime} minutes" : 'N/A' %></div>
        </div>
      </div>
    </section>
  </div>
</div>

<script>
  // Toggle watched status for a movie
  async function toggleWatched(movieId, watched) {
    const method = watched ? 'POST' : 'DELETE';
    const url = watched ? '/watched_movies' : `/watched_movies/${movieId}`;
    
    try {
      const response = await fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({ movie_id: movieId })
      });
      
      const data = await response.json();
      
      if (data.success) {
        window.location.reload();
      } else {
        alert(data.error || 'Failed to update watched status');
      }
    } catch (error) {
      console.error('Error updating watched status:', error);
      alert('Failed to update watched status');
    }
  }
</script>

